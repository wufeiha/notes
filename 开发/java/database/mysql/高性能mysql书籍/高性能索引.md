## 索引类型

按数据结构分类可分为：**B+tree索引、Hash索引、Full-text索引**。
按物理存储分类可分为：**聚簇索引、二级索引（辅助索引）**。
按字段特性分类可分为：**主键索引、普通索引、前缀索引**。
按字段个数分类可分为：**单列索引、联合索引**。

### 结构分类

#### B-Tree索引

##### BTree

![在这里插入图片描述](https://i.loli.net/2021/08/08/yKeUzhcljOZo8Dr.png)

##### B+Tree

B+Tree相对于B-Tree有几点不同：

1. 非叶子节点只存储键值信息。
2. 所有叶子节点之间都有一个链指针。
3. 数据记录都存放在叶子节点中

![在这里插入图片描述](https://i.loli.net/2021/08/08/1Jr2LiF6nuYAwPG.png)

InnoDB存储引擎中页的大小为16KB，一般表的主键类型为INT（占用4个字节）或BIGINT（占用8个字节），指针类型也一般为4或8个字节，也就是说一个页（B+Tree中的一个节点）中大概存储16KB/(8B+8B)=1K个键值（因为是估值，为方便计算，这里的K取值为〖10〗3）。也就是说一个深度为3的B+Tree索引可以维护103 * 10^3 * 10^3 = 10亿 条记录。

#### 哈希索引

- hash索引只包含hash值，而不存储字段值
- hash索引数据不是按照索引值顺序存储的，所以无法用于排序
- 不支持部分匹配，只能全部内容匹配。
- 只支持等值查询，不支持范围查询
- hash冲突很多，索引的维护代价很高，删除行需要遍历slot槽中所有的行

#### 空间数据索引(R-Tree)

这类索引无须前缀查询，空间索引会从所有维度来索引数据，可以有效地使用任意维度来组合查询，必须使用GIS相关函数如MBRCONTAINS()来维护数据，但是mysql对gis的支持不太完善。

#### 全文索引

类似搜索引擎的分词，不是简单的匹配

### 物理存储分类

#### 聚簇索引

聚簇索引的每个叶子节点存储了一行完整的表数据。

![聚簇索引B+tree示意图（图片来源于网络）](https://i.loli.net/2021/08/08/2hgyHF6IGcipDY7.png)

#### 二级索引

二级索引的叶子节点并不存储一行完整的表数据，而是存储了聚簇索引所在列的值(id)。

![二级索引B+tree示意图（图片来源于网络）](https://i.loli.net/2021/08/08/uBWTsPCzgZdAvVo.png)

##### 回表查询

由于二级索引的叶子节点不存储完整的表数据，索引当通过二级索引查询到聚簇索引列值后，还需要回到聚簇索引也就是表数据本身进一步获取数据

## 索引作用

- 减少了需要扫描的数据量，间接减少了锁定的行
- 避免排序和临时表
- 将随机I/O变为顺序I/O

## 策略

- 索引不能是表达式的一部分，也不能是函数的参数

- 使用前缀索引，缩小索引体积，加快索引速度。mysql无法使用前缀索引做order和group，也不能做覆盖扫描。

- 组合索引。注意多列索引的顺序。 如果不考虑分组和排序，将选择性强的列放到前面。

- 注意某些特殊值查询带来的性能问题。例如某个用户下消息特别多，几乎整张表都是他的消息，对这类查询可以禁用。

- 性能不只是依赖于索引列的选择性，也和查询条件的具体值有关。

- 聚簇索引，每张表只能有一个聚簇索引，必须是主键
  - 更新聚簇索引的代价很高，因为会移动被更新行的位置。
  
- 随机主键无序所以会导致页分裂，页会变得稀疏并被不规则地填充，所以数据会有碎片，需要做一次OPTIMIZE TABLE 优化重建表

- 高并发按主键顺序插入会导致争用，导致间隙锁竞争。

- mysql只能用BTree索引做覆盖索引。

- 延迟关联。减少回表与解决limit性能差等问题。适用大的数据集返回小结果集的情况

  - ```sql
    select * from table1 where a>1000 order by b limit 1000,10
    ```
    
    改写为
    
    ```sql
    select * from table1 t1 inner join (select id from table1 where a>1000 order by b limit 1000,10)t2 on t1.id=t2.id
    ```
  
- order by

  - 索引的顺序和order by 子句的顺序完全一致，并且所有列的排序(正倒叙)都一样时，才能使用索引对结果做排序。【见高性能mysql第三版5.3.7】
  - 查询关联多张表，只有order by引用的字段都为第一个表时，才能使用索引做排序。
  
- myisam前缀压缩索引，空间占用少，使得更多的索引可以加载到内存。但是无法使用二分查找，索引上查找速度慢

- 避免在单个列上创建重复索引或者冗余索引【(a)是(a,b)的冗余索引，(b)不是(a,b)的冗余索引】。

- 删除不被使用的索引。

- 如果mysql使用某个索引进行范围搜索，也就无法使用另一个索引(或者组合索引的后续字段)进行排序了

## 案例

## 维护